<%- include('partials/header') %>

<div class="meus-teste">
  <div class="container">
    <div class="row">

      <!-- T√≠tulo -->
      <div class="col-md-12">
        <h1 class="text-center mt-5" style="color: #da2e2e;">
          <strong>Teste de Desempenho</strong>
        </h1>
        <hr><br>
      </div>

      <!-- Instru√ß√µes -->
      <div class="text-center col-md-12" id="instrucoes" style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f7ff 100%); border: 2px solid #1890ff; border-radius: 15px; padding: 30px; margin: 20px auto; max-width: 600px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
        <h3 style="color: #da2e2e; font-size: 28px; margin-bottom: 20px;"><strong>Instru√ß√µes:</strong></h3>
        <ul style="color: #333; font-size: 18px; list-style-type: none; padding: 0;">
          <li style="margin-bottom: 10px;">üìñ Leia o texto em voz alta com clareza e flu√™ncia.</li>
          <li style="margin-bottom: 10px;">‚è±Ô∏è Tente manter um ritmo constante durante a leitura.</li>
          <li style="margin-bottom: 20px;">üòä N√£o se preocupe com erros, apenas fa√ßa o seu melhor!</li>
        </ul>
        <button id="startButton" class="btn btn-primary mt-3" style="background: #da2e2e; border: none; border-radius: 10px; padding: 10px 20px; font-size: 18px; font-weight: bold;" onclick="mostrarSecao()">Iniciar Teste</button><br>
      </div>

      <!-- Texto do Teste -->
      <div class="text-center col-md-12" id="textoTeste" style="display:none;">
        <h2 style="color:#da2e2e;">Frase:</h2>
        <h5 style="color:#000000;">N√≠vel: <%= teste.nivel %></h5>
        <div style="background:#fff4de; border-radius:10px; padding:20px; margin:20px auto; max-width:600px;">
          <%= teste.conteudo %>
        </div>
      </div>

      <!-- Microfone -->
      <div class="text-center teste-microfone" id="secaoOculta">
        <br>
        <audio id="audio" controls style="display: none;"></audio>
        <button class="microfone">
          <img src="/img/mic.png" alt="Microfone"/>
          <img src="/img/mic-off.png" alt="Microfone Desligado" style="display:none;"/>
        </button>
        <br><br>
      </div>
      <div id="loading" style="display:none; text-align:center; margin-top: 20px;">
      <img src="/img/loading.gif" alt="Carregando..." width="80" />
        <p>Enviando √°udio e processando...</p>
      </div>


      <!-- Resultado -->
      <div class="resultado text-center" id="resultado" style="margin-top:20px;"></div>

    </div>
  </div>
</div>

<script>
  const startButton = document.getElementById('startButton');
  const secaoOculta = document.getElementById('secaoOculta');
  const micButton = document.querySelector('.microfone');
  const micOnImg = micButton.querySelector('img:nth-child(1)');
  const micOffImg = micButton.querySelector('img:nth-child(2)');
  const audio = document.getElementById('audio');
  const instrucoes = document.getElementById('instrucoes');
  const textoTeste = document.getElementById('textoTeste');
  const resultadoDiv = document.getElementById('resultado');

  let mediaRecorder;
  let chunks = [];
  let gravacaoAtiva = false;

  secaoOculta.style.display = 'none';
  textoTeste.style.display = 'none';

  function mostrarSecao() {
    startButton.style.display = 'none';
    instrucoes.style.display = 'none';
    textoTeste.style.display = 'block';
    secaoOculta.style.display = 'block';
    micButton.style.display = 'inline-block';
    resultadoDiv.innerHTML = '';
  }
 
  function iniciarGravacao() {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        gravacaoAtiva = true;
        micOnImg.style.display = 'none';
        micOffImg.style.display = 'inline';
        chunks = [];
        
        mediaRecorder.ondataavailable = e => chunks.push(e.data);

        mediaRecorder.onstop = () => {
          gravacaoAtiva = false;
          micOnImg.style.display = 'inline';
          micOffImg.style.display = 'none';
          const blob = new Blob(chunks, { type: 'audio/webm' });
          enviarAudio(blob);
        };
      })
      .catch(err => {
        alert('Erro ao acessar microfone: ' + err.message);
        micOnImg.style.display = 'inline';
        micOffImg.style.display = 'none';
      });
  }

function pararGravacao() {
  if (mediaRecorder && gravacaoAtiva) {
    mediaRecorder.stop();
    micOnImg.style.display = 'inline';
    micOffImg.style.display = 'none';
  }
}

  micButton.addEventListener('click', () => {
    if (!gravacaoAtiva) iniciarGravacao();
    else pararGravacao();
  });

function enviarAudio(blob) {
  const loading = document.getElementById('loading');
  const micButton = document.querySelector('.microfone');

  loading.style.display = 'block';
  micButton.style.display = 'none';

  const formData = new FormData();
  formData.append('audio', blob, 'audio.webm');

  fetch('/transcreverAudio', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
      if (data.transcription) {
        console.log('Transcri√ß√£o:', data.transcription);
        salvarTesteComTranscricao(data.transcription);
      } else {
        loading.style.display = 'none';
        micButton.style.display = 'inline-block';
        alert('Erro na transcri√ß√£o.');
      }
    })
    .catch(err => {
      loading.style.display = 'none';
      micButton.style.display = 'inline-block';
      console.error('Erro no envio do √°udio:', err);
      alert('Erro ao enviar √°udio.');
    });
}

  function normalizarTexto(texto) {
    return texto
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[.,!?;:]/g, '')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function compararPalavras(original, transcrito) {
    const orig = normalizarTexto(original).split(' ');
    const trans = normalizarTexto(transcrito).split(' ');

    const erradas = [];
    const faltando = [];
    let extras = [];

    orig.forEach((palavra, i) => {
      if (trans[i] === undefined) faltando.push(palavra);
      else if (palavra !== trans[i]) erradas.push({ esperado: palavra, dito: trans[i] });
    });

    if (trans.length > orig.length) extras = trans.slice(orig.length);

    return { erradas, faltando, extras };
  }

  async function obterMotivosPalavrasErradas(palavrasErradas) {
    const pares = palavrasErradas.slice(0, 3);
    const respostas = [];

    for (const p of pares) {
      const prompt = `A crian√ßa leu "${p.dito}" quando o esperado era "${p.esperado}". Quais s√£o os 3 principais motivos que podem levar a esse erro ao ler? Para cada motivo, indique uma sugest√£o pr√°tica e curta para ajudar a crian√ßa a corrigir esse erro. Responda em texto simples, sem asteriscos, sem negrito, sem markdown, com frases curtas e f√°ceis de entender.`;

      const resp = await fetch('/prompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });

      const data = await resp.json();
      let reply = data.reply || data.resposta || '';

      reply = reply.replace(/^\s*[-*+]\s+/gm, '');
      reply = reply.replace(/\*{1,2}/g, '');
      reply = reply.replace(/_+/g, '');
      reply = reply.trim();

      respostas.push({ esperado: p.esperado, dito: p.dito, motivos: reply });
    }

    return respostas;
  }

  async function salvarTesteComTranscricao(transcricao) {
    const textoOriginal = normalizarTexto("<%= teste.conteudo %>");
    const textoTranscrito = transcricao;
    const comparacao = compararPalavras(textoOriginal, textoTranscrito);

    const resultado = (comparacao.erradas.length === 0 &&
                       comparacao.faltando.length === 0 &&
                       comparacao.extras.length === 0)
                      ? "Correto" : "Incorreto";

    let feedback = "";
    if (resultado === "Incorreto" && comparacao.erradas.length) {
      const motivos = await obterMotivosPalavrasErradas(comparacao.erradas);

      feedback = motivos
        .map(m => `Esperado: "${m.esperado}"  ‚Äî  Dito: "${m.dito}"\n${m.motivos}`)
        .join('\n\n');
    }

    fetch('/realizarTeste', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: "<%= user.id %>",
        textoId: "<%= teste.id %>",
        nivel: "<%= teste.nivel %>",
        resultado,
        feedback,
        transcricao: normalizarTexto(transcricao),
        palavrasErradas: comparacao.erradas,
        palavrasFaltando: comparacao.faltando,
        palavrasExtras: comparacao.extras
      })
    })
    .then(res => res.json())
    .then(() => {
      exibirResultado(comparacao, resultado, feedback, transcricao);
    })
    .catch(err => {
      console.error('Erro ao salvar teste:', err);
      alert('Erro ao salvar teste.');
    });
  }

  function exibirResultado(comparacao, resultado, feedback, transcricao) {
    loading.style.display = 'none';
    const isCorreto = resultado === "Correto";
    resultadoDiv.innerHTML = `
      <div style="background: ${isCorreto ? 'linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%)' : 'linear-gradient(135deg, #fce4e4 0%, #f8d7da 100%)'}; border-radius: 20px; padding: 40px; margin: 40px auto; max-width: 800px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 3px solid ${isCorreto ? '#28a745' : '#dc3545'};">
        <h3 style="color: #da2e2e; margin-bottom: 30px; font-size: 32px; text-align: center; font-weight: bold;">Resultado do Teste</h3>
        <div style="text-align: left; font-size: 18px; line-height: 1.6;">
          <p><strong style="color: #333;">Frase:</strong> <%= teste.conteudo %></p>
          <p><strong style="color: #333;">N√≠vel:</strong> <%= teste.nivel %></p>
          <p><strong style="color: #333;">Resultado:</strong> <span style="color: ${isCorreto ? '#28a745' : '#dc3545'}; font-weight: bold;">${resultado}</span></p>
          <p><strong style="color: #333;">Transcri√ß√£o:</strong> ${transcricao}</p>
          <p><strong style="color: #333;">Feedback:</strong><br><pre style="background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); border: 3px solid #e17055; padding: 20px; border-radius: 15px; white-space: pre-wrap; font-weight: bold; color: #d63031; font-family: Arial, sans-serif; font-size: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">${feedback || "Nenhum feedback"}</pre></p>
          ${comparacao.erradas.length > 0 ? `<p><strong style="color: #333;">Palavras erradas:</strong> ${comparacao.erradas.map(e => `"${e.dito}" (esperado: "${e.esperado}")`).join(', ')}</p>` : ''}
          ${comparacao.faltando.length > 0 ? `<p><strong style="color: #333;">Palavras faltando:</strong> ${comparacao.faltando.join(', ')}</p>` : ''}
          ${comparacao.extras.length > 0 ? `<p><strong style="color: #333;">Palavras extras:</strong> ${comparacao.extras.join(', ')}</p>` : ''}
        </div>
      </div>
    `;

    document.querySelector('.meus-teste .row .col-md-12:first-child').style.display = 'none';
    document.getElementById('instrucoes').style.display = 'none';
    document.getElementById('textoTeste').style.display = 'none';
    document.getElementById('secaoOculta').style.display = 'none';
  }
</script>

<%- include('partials/footer') %>
