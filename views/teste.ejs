<%- include('partials/header') %>
<div class="container">
  <h1><%= teste.titulo %></h1>

  <div class="frase">
    <%= teste.conteudo %>
  </div>

  <div class="microfone">
    <button id="btnMic">ğŸ¤</button>
    <p id="status">Pressione para comeÃ§ar</p>
  </div>

  <p id="resultado"></p>
</div>

<script>
  const btnMic = document.getElementById("btnMic");
  const statusEl = document.getElementById("status");
  const resultadoEl = document.getElementById("resultado");

  // ConfiguraÃ§Ã£o do reconhecimento de voz
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = "pt-BR";
  recognition.interimResults = false;

  let ouvindo = false;
  let forcarParada = false; // Flag para saber se o usuÃ¡rio clicou para parar

  btnMic.addEventListener("click", () => {
    if (!ouvindo) {
      recognition.start();
      ouvindo = true;
      forcarParada = false;
      btnMic.innerText = "â¹ï¸"; // muda o Ã­cone para "parar"
      statusEl.innerText = "Ouvindo...";
    } else {
      forcarParada = true;
      recognition.stop();
      ouvindo = false;
      btnMic.innerText = "ğŸ¤"; // volta para o Ã­cone de microfone
      statusEl.innerText = "Parado";
    }
  });

  recognition.onresult = (event) => {
    const texto = event.results[0][0].transcript;
    resultadoEl.innerText = "VocÃª disse: " + texto;
    statusEl.innerText = "ConcluÃ­do âœ…";
    ouvindo = false;
    btnMic.innerText = "ğŸ¤";

    // Enviar o resultado para o backend
    fetch("/realizarTeste", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: "<%= user.id %>",
        textoId: "<%= teste.id %>",
        resultado: texto,
        feedback: ""
      })
    })
    .then(res => res.json())
    .then(data => console.log("Salvo:", data))
    .catch(err => console.error("Erro ao salvar:", err));
  };

  recognition.onerror = (event) => {
    statusEl.innerText = "Erro: " + event.error;
    ouvindo = false;
    btnMic.innerText = "ğŸ¤";
  };

  recognition.onend = () => {
    if (!forcarParada && ouvindo) {
      // Se nÃ£o foi o usuÃ¡rio que parou, reinicia automaticamente
      recognition.start();
      statusEl.innerText = "Ouvindo...";
    } else {
      ouvindo = false;
      btnMic.innerText = "ğŸ¤";
      statusEl.innerText = "Pressione para tentar novamente";
    }
  };
</script>
<%- include('partials/footer') %>
</body>
</html>