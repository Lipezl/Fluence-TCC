<%- include('partials/header') %>
<div class="meus-teste">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1 class="text-center mt-5" style="color: #da2e2e;"><strong>Teste de Desempenho</strong></h1><hr><br>
      </div>
      <div class="text-center col-md-12" id="instrucoes">
        <h3 style="color: #da2e2e;"><strong>Instruções:</strong></h3>
        <ul style="color: black; font-size: 18px;">
          <li class="text-center">Leia o texto em voz alta com clareza e fluência.</li>
          <li class="text-center">Tente manter um ritmo constante durante a leitura.</li>
          <li class="text-center">Não se preocupe com erros, apenas faça o seu melhor!</li>
        </ul>
        <button id="startButton" class="btn btn-primary mt-3" onclick="mostrarSecao()">Iniciar Teste</button><br>
      </div>
      <div class="text-center col-md-12" id="textoTeste" style="display:none;">
        <h2 style="color:#da2e2e;">Frase:</h2>
        <h5 style="color:#000000;">Nível: <%= teste.nivel %></h5>
        <div style="background:#fff4de; border-radius:10px; padding:20px; margin:20px auto; max-width:600px;">
          <%= teste.conteudo %>
        </div>
      </div>
      <div class="text-center teste-microfone" id="secaoOculta">
        <br><audio id="audio" controls style="display: none;"></audio>
        <button class="microfone">
          <img src="/img/mic.png" alt="Microfone"/>
        </button><br><br>
        <button id="stopButton" class="btn btn-secondary mt-3" disabled>Parar</button>
      </div>
    </div>
  </div>
</div>
<script>
  const startButton = document.getElementById('startButton');
  const secaoOculta = document.getElementById('secaoOculta');
  const micButton = document.querySelector('.microfone');
  const stopButton = document.getElementById('stopButton');
  const audio = document.getElementById('audio');
  const instrucoes = document.getElementById('instrucoes');
  const textoTeste = document.getElementById('textoTeste');

  let mediaRecorder;
  let chunks = [];
  let gravacaoAtiva = false;

  // Esconde a seção do microfone e o texto inicialmente
  secaoOculta.style.display = 'none';
  textoTeste.style.display = 'none';

  // Mostra a seção do microfone, o texto e esconde o botão de iniciar e instruções
  function mostrarSecao() {
    startButton.style.display = 'none';
    instrucoes.style.display = 'none';
    textoTeste.style.display = 'block';
    secaoOculta.style.display = 'block';
    micButton.style.display = 'inline-block';
    stopButton.disabled = true;
  }

  // Função para iniciar gravação de áudio
  function iniciarGravacao() {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        gravacaoAtiva = true;
        micButton.querySelector('img').src = "/img/mic-on.png";
        stopButton.disabled = false;
        chunks = [];

        mediaRecorder.ondataavailable = e => {
          chunks.push(e.data);
        };

        mediaRecorder.onstop = e => {
          gravacaoAtiva = false;

          const blob = new Blob(chunks, { type: 'audio/webm' });
          audio.src = URL.createObjectURL(blob);
          audio.style.display = 'block';

          enviarAudio(blob);
        };
      })
      .catch(err => {
        alert('Erro ao acessar microfone: ' + err.message);
      });
  }

  // Função para parar a gravação
  function pararGravacao() {
    if (mediaRecorder && gravacaoAtiva) {
      mediaRecorder.stop();
      micButton.querySelector('img').src = "/img/mic.png";
      stopButton.disabled = true;
    }
  }

  micButton.addEventListener('click', () => {
    if (!gravacaoAtiva) {
      iniciarGravacao();
    } else {
      pararGravacao();
    }
  });

  stopButton.addEventListener('click', () => {
    pararGravacao();
  });

  // Envia áudio para backend para transcrição
  function enviarAudio(blob) {
    const formData = new FormData();
    formData.append('audio', blob, 'audio.webm');

    fetch('/transcreverAudio', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if(data.transcription) {
        console.log('Transcrição:', data.transcription);
        salvarTesteComTranscricao(data.transcription);
      } else {
        alert('Erro na transcrição');
      }
    })
    .catch(err => {
      console.error('Erro no envio do áudio:', err);
    });
  }
  
  function normalizarTexto(texto){
    return texto
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[.,!?;:]/g, '')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function compararPalavras (original, transcrito){
    const orig = normalizarTexto(original).split(' ');
    const trans = normalizarTexto(transcrito).split(' ');

    let erradas = [];
    let faltando = [];
    let extras = [];

    orig.forEach((palavra, i)=>{
      if (trans[i] === undefined){
        faltando.push(palavra);
      }
      else if (palavra !== trans[i]){
        erradas.push({ esperado: palavra, dito: trans[i] });
      }
    });

    if (trans.length > orig.length){
      extras = trans.slice(orig.length);
    }
    return { erradas, faltando, extras };
  }

  async function obterMotivosPalavrasErradas(palavrasErradas) {
  // Pega até 3 palavras erradas
  const palavras = palavrasErradas.slice(0, 3).map(e => e.esperado);
  const respostas = [];

  for (const palavra of palavras) {
    const prompt = `Quais são os 3 principais motivos que levam uma criança a errar a palavra "${palavra}" ao ler, dê uma resposta apenas com os motivos, de forma curta?`;
    const resp = await fetch('/prompt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
    const data = await resp.json();
    respostas.push({ palavra, motivos: data.reply });
  }
  return respostas;
}

  async function salvarTesteComTranscricao(transcricao) {
    let resultado = "";

    const textoOriginal = normalizarTexto("<%= teste.conteudo %>");
    const textoTranscrito = transcricao;
    const comparacao = compararPalavras(textoOriginal, textoTranscrito);
    if (
      comparacao.erradas.length === 0 &&
      comparacao.faltando.length === 0 &&
      comparacao.extras.length === 0
    ) {
      resultado = "Correto";
    } else {
      resultado = "Incorreto";
    }

    fetch('/realizarTeste', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: "<%= user.id %>",
        textoId: "<%= teste.id %>",
        nivel: "<%= teste.nivel %>",
        resultado: resultado,
        feedback: JSON.stringify(comparacao), //Arrumar para armazenar a resposta do prompt
        transcricao: normalizarTexto(transcricao)
      })
    })
    .then(res => res.json())
    .then(async data => {
      let msg = 'Teste salvo com sucesso!\n';
      if (resultado === "Incorreto") {
        if (comparacao.erradas.length)
          msg += `Palavras erradas: ${comparacao.erradas.map(e => `"${e.dito}" (esperado: "${e.esperado}")`).join(', ')}\n`;
        if (comparacao.faltando.length)
          msg += `Palavras faltando: ${comparacao.faltando.join(', ')}\n`;
        if (comparacao.extras.length)
          msg += `Palavras a mais: ${comparacao.extras.join(', ')}\n`;

        // Consulta motivos dos erros ao Gemini
        if (comparacao.erradas.length) {
          const motivos = await obterMotivosPalavrasErradas(comparacao.erradas);
          motivos.forEach(m => {
            msg += `\nMotivos para errar "${m.palavra}":\n${m.motivos}\n`;
          });
        }
      }
      alert(msg); 
    })
    .catch(err => {
      console.error('Erro ao salvar teste:', err);
      alert('Erro ao salvar teste.');
    });
  }
</script>
<%- include('partials/footer') %>